(function(e){function r(e,t){this._point=e;this._vector=t}function i(e,t,n,r,i,s){this._align=[e,t];Kinetic.Circle.call(this,{radius:n,fill:r,stroke:i,strokeWidth:s,draggable:true})}function s(t,r){this._target=t;this._options=e.extend({},n,r);this._rotateHandler=null;this._border=null;this._selectedHandler=null;this._handlers=[];Kinetic.Group.call(this);var i=this._target.getParent();i.setDraggable(true);this.createBorder();this.addHandler(s.LEFT,s.TOP);this.addHandler(s.RIGHT,s.TOP);this.addHandler(s.LEFT,s.BOTTOM);this.addHandler(s.RIGHT,s.BOTTOM);this.addHandler(s.CENTER,s.TOP);this.addHandler(s.LEFT,s.MIDDLE);this.addHandler(s.RIGHT,s.MIDDLE);this.addHandler(s.CENTER,s.BOTTOM);this.createRotateHandler();this.update()}function o(n){return e(n).data(t+":tool")}function u(n,r){e(n).data(t+":tool",r)}function a(e){var t=e.getParent();var n=o(e);var r=e.getStage();if(typeof n!="undefined"){t.setDraggable(true);n.show();r.draw()}}function f(e){var t=e.getParent();var n=o(e);var r=e.getStage();if(typeof n!="undefined"){t.setDraggable(false);n.hide();r.draw()}}function l(e){var t=o(e);var n=e.getStage();if(typeof t!="undefined"){if(t.getVisible()){f(e)}else{a(e)}}}function c(e,t){var n=e.getParent();var r=new Kinetic.Group({x:e.getX()+e.getWidth()/2,y:e.getY()+e.getHeight()/2});n.add(r);e.remove();r.add(e);e.setPosition(0,0);e.setOffset({x:e.getWidth()/2,y:e.getHeight()/2});var i=new s(e,t);r.add(i);u(e,i);n.draw()}var t="transformTool";var n={"handler-radius":5,"handler-fill":"white","handler-stroke":"black","handler-stroke-width":2,"border-stroke":"black","border-stroke-width":2,"rotate-distance":35};r.prototype.getPoint=function(){return this._point};r.prototype.getVector=function(){return this._vector};Kinetic.Util.extend(i,Kinetic.Circle);i.prototype.getAlign=function(){return this._align};Kinetic.Util.extend(s,Kinetic.Group);s.LEFT=-1;s.CENTER=0;s.RIGHT=1;s.TOP=-1;s.MIDDLE=0;s.BOTTOM=1;s.prototype.getNearestPoint=function(e,t){var n=e.getPoint();var r=e.getVector();var i=((t.x-n.x)*r.x+(t.y-n.y)*r.y)/(Math.pow(r.x,2)+Math.pow(r.y,2));return{x:n.x+r.x*i,y:n.y+r.y*i}};s.prototype.getAngle=function(e){return Math.atan2(e.y,e.x)-Math.PI/2};s.prototype.createBorder=function(){this._border=new Kinetic.Line({points:[0,0],stroke:this._options["border-stroke"],strokeWidth:this._options["border-stroke-width"]});this.add(this._border)};s.prototype.createRotateHandler=function(){var e=this;this._rotateHandler=new Kinetic.Circle({radius:this._options["handler-radius"],fill:this._options["handler-fill"],stroke:this._options["handler-stroke"],strokeWidth:this._options["handler-stroke-width"],draggable:true,dragBoundFunc:function(t){if(this.isDragging()){var n=e.getParent();var r=n.getAbsolutePosition();var i={x:r.x-t.x,y:r.y-t.y};var s=e.getAngle(i);n.setRotation(s)}return t}});this._rotateHandler.on("dragmove",function(){e.update()});this.add(this._rotateHandler);return this._rotateHandler};s.prototype.addHandler=function(e,t){var n=this;var s=new i(e,t,this._options["handler-radius"],this._options["handler-fill"],this._options["handler-stroke"],this._options["handler-stroke-width"]);var o={point:{x:0,y:0},vector:{x:0,y:0}};s.setDragBoundFunc(function(e){if(this.isDragging()){e=n.getNearestPoint(o,e)}return e});s.on("mousedown",function(){var e=this.getAbsolutePosition();var t=n.getOppositeHandler(this).getAbsolutePosition();var i={x:t.x-e.x,y:t.y-e.y};n._selectedHandled=this;o=new r(e,i)});s.on("mouseup",function(){n._selectedHandled=null});s.on("dragmove",function(){n.apply();n.update()});this.add(s);this._handlers.push(s);return s};s.prototype.apply=function(){var e=this._selectedHandled.getPosition();var t=this._selectedHandled.getAlign();var n=t[0]!=0?Math.abs(2*e.x):this._target.getWidth();var r=t[1]!=0?Math.abs(2*e.y):this._target.getHeight();this._target.setSize(n,r);this._target.setOffset(n/2,r/2)};s.prototype.getHandlerByAlign=function(t,n){var r=null;e.each(this._handlers,function(){var e=this.getAlign();if(e[0]==t&&e[1]==n){r=this;return false}});return r};s.prototype.getOppositeHandler=function(e){var t=e.getAlign();return this.getHandlerByAlign(-t[0],-t[1])};s.prototype.update=function(){var e=this._target.getX()-this._target.getOffsetX();var t=this._target.getY()-this._target.getOffsetY();var n=this._target.getWidth();var r=this._target.getHeight();var i={x:e+n/2,y:t-this._options["rotate-distance"]};var o={x:e,y:t};var u={x:e+n,y:t};var a={x:e,y:t+r};var f={x:e+n,y:t+r};var l={x:e+n/2,y:t};var c={x:e,y:t+r/2};var h={x:e+n,y:t+r/2};var p={x:e+n/2,y:t+r};this._border.setPoints([i,l,o,a,f,u,l]);this._rotateHandler.setPosition(i);this.getHandlerByAlign(s.LEFT,s.TOP).setPosition(o);this.getHandlerByAlign(s.RIGHT,s.TOP).setPosition(u);this.getHandlerByAlign(s.LEFT,s.BOTTOM).setPosition(a);this.getHandlerByAlign(s.RIGHT,s.BOTTOM).setPosition(f);this.getHandlerByAlign(s.CENTER,s.TOP).setPosition(l);this.getHandlerByAlign(s.LEFT,s.MIDDLE).setPosition(c);this.getHandlerByAlign(s.RIGHT,s.MIDDLE).setPosition(h);this.getHandlerByAlign(s.CENTER,s.BOTTOM).setPosition(p)};var h={init:function(e){return this.each(function(){var t=this;var n=o(t);if(typeof n!="undefined"){a(t)}else{var r=t.getStage();if(typeof r!="undefined"){c(t,e)}else{var i=setInterval(function(){r=t.getStage();if(typeof r!="undefined"){clearInterval(i);c(t,e)}},100)}}})},hide:function(){return this.each(function(){var e=this;f(e)})},show:function(){return this.each(function(){var e=this;a(e)})},toggle:function(){return this.each(function(){var e=this;l(e)})}};e.fn[t]=function(t){var n=null;if(typeof t=="string"){var r=Array.prototype.slice.call(arguments,1);var i=h[t];if(typeof i=="undefined"){e.error("Method not found: "+t)}n=i.apply(this,r)}else{n=h.init.apply(this,arguments)}return n}})(jQuery)
